<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <link href="./css/output.css" rel="stylesheet" />
    <style>
      .typing-dots {
        display: flex;
        gap: 0.25rem;
      }

      .typing-dots span {
        width: 0.4rem;
        height: 0.4rem;
        border-radius: 9999px;
        background: #e5e7eb;
        opacity: 0.2;
        animation: bounce 1s infinite ease-in-out;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: translateY(0);
          opacity: 0.2;
        }

        40% {
          transform: translateY(-0.2rem);
          opacity: 1;
        }
      }
    </style>
  </head>

  <body
    class="bg-gray-800 text-gray-200 min-h-screen flex flex-col items-center"
  >
    <div class="w-full bg-gray-900 text-center p-6 fixed top-0 left-0">
      <div class="text-3xl font-bold">Personal Python Tutor</div>
      <div class="text-xl text-gray-400">Ask me questions about Python!</div>
    </div>
    <div
      id="chatArea"
      class="flex flex-col w-full md:w-1/2 pt-32 pb-32 px-4 overflow-y-auto"
    ></div>
    <form
      id="chatForm"
      hx-post="/api/message"
      hx-target="#chatArea"
      hx-swap="beforeend"
      hx-on::before-request="addUserMessageAndThinking(event)"
      hx-on::after-request="removeThinkingBubble(); this.reset();"
      class="fixed bottom-0 left-0 w-full bg-gray-900 p-4 flex justify-center"
    >
      <div class="flex w-full md:w-1/2 items-end space-x-2">
        <textarea
          id="chatInput"
          name="message"
          placeholder="Type your question..."
          rows="1"
          class="flex-grow resize-none bg-gray-700 text-white p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 overflow-y-auto"
        ></textarea>
        <button
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md"
        >
          Send
        </button>
      </div>
    </form>
    <script>
      const textarea = document.getElementById("chatInput");
      const chatArea = document.getElementById("chatArea");

      textarea.addEventListener("input", () => {
        textarea.style.height = "auto";
        const lineHeight = parseFloat(getComputedStyle(textarea).lineHeight);
        const maxHeight = lineHeight * 5;
        textarea.style.overflowY =
          textarea.scrollHeight > maxHeight ? "auto" : "hidden";
        textarea.style.height =
          Math.min(textarea.scrollHeight, maxHeight) + "px";
      });

      function addUserMessageAndThinking(evt) {
        const form = evt.target;
        const textarea = form.querySelector("#chatInput");
        const text = textarea.value.trim();

        if (!text) {
          evt.preventDefault();
          return;
        }

        const userDiv = document.createElement("div");
        userDiv.className =
          "my-2 bg-blue-600 p-3 rounded-lg self-end max-w-[80%]";
        userDiv.textContent = text;
        chatArea.appendChild(userDiv);

        addThinkingBubble();

        chatArea.scrollTop = chatArea.scrollHeight;
      }

      function addThinkingBubble() {
        if (document.getElementById("thinking-bubble")) return;

        const bubble = document.createElement("div");
        bubble.id = "thinking-bubble";
        bubble.className =
          "my-2 bg-gray-700 p-3 rounded-lg self-start max-w-[80%] flex items-center space-x-2";

        const dots = document.createElement("div");
        dots.className = "typing-dots";
        dots.innerHTML = "<span></span><span></span><span></span>";

        bubble.appendChild(dots);

        chatArea.appendChild(bubble);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      function removeThinkingBubble() {
        const bubble = document.getElementById("thinking-bubble");
        if (bubble) bubble.remove();
      }
      document.body.addEventListener("htmx:afterSwap", (evt) => {
        if (evt.detail.target.id === "chatArea") {
          chatArea.scrollTop = chatArea.scrollHeight;
        }
      });
    </script>
  </body>
</html>
